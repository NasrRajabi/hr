{% extends "master.twig" %}


{% block style %}
	<style>
		.btn-group {
			width: 100%;
		}
	</style>
{% endblock %}


{% block main %}


	<main class="col ms-1">
		<div class="card">

			<div class="card-body">
				<div class="progress" role="progressbar" id="progress" style="display: none" aria-label="Animated striped example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
					<div class="progress-bar progress-bar-striped progress-bar-animated  bg-info" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
				</div>

				<div x-data="dataTable()">
					<div class="container-fluid mt-3">
						<div class="d-flex flex-row-reverse mb-3 ">

							{% if permissions['add_device']  %}
								<button type="button" class="btn bg-primary-subtle ms-2" data-bs-toggle="modal" data-bs-target="#add_device">
									<i class="bi bi-node-plus fs-4 p-1"></i>
									إضافة ساعة
								</button>
							{% endif %}
							<!--Add Device Modal -->
							<div class="modal fade" id="add_device" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
								<div class="modal-dialog  modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h1 class="modal-title fs-5" id="staticBackdropLabel">
												إضافة ساعة جديدة</h1>
											<div class="d-flex flex-row-reverse mb-3 ">
												<button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close"></button>
											</div>
										</div>
										<div class="modal-body ">
											<div class="container-fluid">


												<div class="row g-3 align-items-center bg-info-subtle rounded my-3">
													<div class="col-auto">
														<label class="col-form-label">رقم الساعة</label>
													</div>
													<div class="col-auto">
														<input type="text" readonly class="form-control-plaintext" value={{last_device_id}} aria-labelledby="passwordHelpInline">
													</div>
													<div class="col-auto">
														<span id="passwordHelpInline" class="form-text">
															<label class="col-form-label">
																PORT 4370
															</label>
														</span>
													</div>
												</div>

												<div class="row">
													<div class="col-10 form-floating mb-3">
														<input type="text" class="form-control" x-model="name" name="name" id="floatingInput" placeholder=" اسم الساعة" aria-label=" اسم الساعة">
														<label for="floatingInput">
															اسم الساعة
														</label>
													</div>
												</div>

												<div class="row">
													<div class="form-floating mb-3 col-9">

														<input type="text" class="form-control" x-model="device_ip" name="device_ip" id="floatingInputGrid" placeholder="225.225.225.225" value="225.225.225.225">
														<label for="floatingInputGrid">IP Address</label>

													</div>


												</div>


												<div class="row g-2 align-items-right">
													<div class="col-sm-6 rounded form-floating ">
														<select name="area" x-model="area" class="form-select" id="floatingInput" aria-label="Default select example">
															<option selected>--- اختر المحافظة ---</option>
															{% for key, value in lookups.city %}

																<option value="{{ key }}" {{ old.city == key ? 'selected' : '' }}>{{ value }}</option>

															{% endfor %}
														</select>
														<label for="floatingInput">المحافظة
														</label>
													</div>
												</div>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary " data-bs-dismiss="modal">إغلاق</button>
											<button x-on:click="storeDevice($event.target, name, device_ip, area)" type="button" class="btn btn-info">حفظ</button>
										</div>

									</div>
								</div>
							</div>
							{% if permissions['transfer_data']  %}
								<button x-on:click="allTransferData($event.target)" type="button" class="btn bg-info-subtle ms-2">
									<i class="bi bi-fingerprint  fs-4 p-1"></i>
									سحب الدوام
								</button>
							{% endif %}
							{% if permissions['check_connect']  %}
								<button x-on:click="allCheckConnect($event.target)" type="button" class="btn bg-warning-subtle ms-2">
									<i class="bi bi-plugin  fs-4 p-1"></i>
									فحص الاتصال
								</button>
							{% endif %}
							{% if permissions['set_time']  %}
								<button x-on:click="allSetTime($event.target)" type="button" class="btn bg-danger-subtle ms-2">
									<i class="bi bi-clock  fs-4 p-1"></i>
									مزامنة الوقت
								</button>
							{% endif %}
						</div>

						<div class="table-responsive">
							<div class="mb-3">
								<input type="text" id="search" x-model="searchTerm" class="form-control" placeholder="ابحث عن الساعة"/>
							</div>
							<table class="table table-striped table-bordered table-hover align-middle">
								<thead>
									<tr>
										<th class="text-center fit">#</th>
										<th class="text-center fit">IP</th>
										<th class="text-center fit">اسم الساعة</th>
										<th class="text-center fit">حالة الاتصال</th>
										{# <th class="text-center fit">المنطقة</th>
																																																																																																																																																																														<th class="text-center fit">Serial</th> #}
										<th class="text-center fit">النتائج</th>
										<th class="text-center fit">الاجراءات</th>
									</tr>
								</thead>
								<tbody class="table-group-divider">

									<template x-for="(row, index) in filteredRows" :key="index">
										<tr>
											<td class="text-center fit" x-text="row.id"></td>
											<td class="text-center fit" x-text="row.ip"></td>
											<td class="text-center fit" x-text="row.name"></td>
											<td class="text-center fit" x-html="row.status"></td>
											{# <td class="text-center fit" x-text="row.area"></td>
																																																																																																																																																																																																<td class="text-center fit" x-text="row.serial"></td> #}
											<td class="text-center fit" x-html="row.data"></td>
											<td class="text-center fit">
												{% if permissions['transfer_data']  %}
													<button x-on:click="transferData($event.target, row)" type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="سحب الدوام">
														<i class="bi bi-fingerprint fs-5"></i>
													</button>
												{% endif %}
												{% if permissions['check_connect']  %}
													<button x-on:click="checkConnect($event.target, row)" type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="فحص الاتصال">
														<i class="bi bi-plugin fs-5"></i>
													</button>
												{% endif %}
												{% if permissions['restart']  %}
													<button x-on:click="restart($event.target, row)" type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="إعادة تشغيل">
														<i class="bi bi-recycle fs-5"></i>
													</button>
												{% endif %}
												{% if permissions['get_user']  %}
													<button type="button" x-on:click="getUser($event.target, row)" class="btn btn-outline-info btn-sm">
														<i class="bi bi-people-fill fs-5" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="قائمة الموظفين"></i>
													</button>
												{% endif %}
												<!-- Modal -->
												<div class="modal fade" id="showGetUserModal" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
													<div class="modal-dialog modal-dialog-scrollable">
														<div class="modal-content">
															<div class="modal-header">
																<h1 class="modal-title fs-5" id="staticBackdropLabel">
																	قائمة الموظفين</h1>
																<div class="d-flex flex-row-reverse mb-3 ">
																	<button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close"></button>
																</div>
															</div>
															<div class="modal-body">
																<table class="table  table-striped" id="getUserTable">
																	<thead>
																		<tr>
																			<th scope="col">#</th>
																			<th scope="col">اسم الموظف</th>
																			<th scope="col">الرقم الوظيفي</th>
																			<th scope="col">الصلاحية</th>

																		</tr>
																	</thead>
																	<tbody></tbody>

																</table>
															</div>
															<div class="modal-footer">
																<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
															</div>
														</div>
													</div>
												</div>
												{% if permissions['set_user']  %}
													<span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="اضافة موظف">
														<button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" x-bind:data-bs-target="'#addEmp'+ row.id">
															<i class="bi bi-person-plus-fill fs-5"></i>
														</button>
													</span>
												{% endif %}

												<!-- Modal -->
												<div class="modal fade" x-bind:id="'addEmp'+ row.id" id="addEmpModal" tabindex="-1" aria-labelledby="addEmpModalLabel" aria-hidden="true">
													<div class="modal-dialog">
														<div class="modal-content">
															<div class="modal-header">
																<h1 class="modal-title fs-5" id="addEmpModalLabel">
																	اضافة موظف على ساعة الدوام
																</h1>
																<div class="d-flex flex-row-reverse mb-3 ">
																	<button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close"></button>
																</div>
															</div>
															<div class="modal-body ">

																<input x-model="add_employee_no" name="employee_no" class="form-control mb-3" type="text" placeholder="الرقم الوظيفي" aria-label=".form-control-lg example">

																<select x-model="role" name="role" class="form-select" aria-label="Default select example">
																	<option selected>
																		الصلاحية</option>
																	{% for key, value in lookups.ac_role %}


																		<option value="{{ key }} ">{{ value }}</option>

																	{% endfor %}
																</select>
															</div>
															<div class="modal-footer">
																<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
																<button x-on:click="setUser($event.target, row, add_employee_no, role)" type="button" class="btn btn-primary">حفظ</button>
															</div>
														</div>
													</div>
												</div>

												{% if permissions['set_time']  %}
													<button x-on:click="setTime($event.target, row)" type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="مزامنة الوقت">
														<i class="bi bi-clock fs-5"></i>
													</button>
												{% endif %}
												{% if permissions['check_voice']  %}
													<button x-on:click="checkVoice($event.target, row)" type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="فحص الصوت على الساعة">
														<i class="bi bi-mic-fill fs-5"></i>
													</button>
												{% endif %}
												{% if permissions['edit_device']  %}
													<span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="تعديل الجهاز">
														<button type="button" class="btn btn-outline-warning btn-sm" x-bind:data-bs-target="'#editDevice'+ row.id" data-bs-toggle="modal" data-bs-target="#editDevice">
															<i class="bi bi-pencil-square fs-5"></i>
														</button>
													</span>
												{% endif %}
												<!-- Modal -->
												<div class="modal fade" id="editDevice" x-bind:id="'editDevice'+ row.id" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
													<div class="modal-dialog  modal-lg">
														<div class="modal-content">
															<div class="modal-header">
																<h1 class="modal-title fs-5" id="staticBackdropLabel">
																	تعديل ساعة
																</h1>
																<div class="d-flex flex-row-reverse mb-3 ">
																	<button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close"></button>
																</div>
															</div>
															<div class="modal-body ">

																<div class="container-fluid">

																	<div class="row mb-3">


																		<div class="row g-3 align-items-center bg-info-subtle rounded my-3">
																			<div class="col-auto">
																				<label class="col-form-label">رقم الساعة</label>
																			</div>
																			<div class="col-auto">
																				<input type="text" readonly class="form-control-plaintext" value={{last_device_id}} aria-labelledby="passwordHelpInline">
																			</div>
																			<div class="col-auto">
																				<span id="passwordHelpInline" class="form-text">
																					<label class="col-form-label">
																						PORT 4370
																					</label>
																				</span>
																			</div>
																		</div>


																		<div class="row">
																			<div class="col-10 form-floating mb-3">
																				<input type="text" class="form-control" x-model="row.name" name="name" id="floatingInput" placeholder=" اسم الساعة" aria-label=" اسم الساعة">
																				<label for="floatingInput">
																					اسم الساعة
																				</label>
																			</div>
																		</div>

																		<div class="row">
																			<div class="form-floating mb-3 col-9">

																				<input type="text" class="form-control" x-model="row.ip" name="device_ip" id="floatingInputGrid" placeholder="225.225.225.225" value="225.225.225.225">
																				<label for="floatingInputGrid">IP Address</label>

																			</div>


																		</div>
																	</div>

																	<div class="row g-2 align-items-right">
																		<div class="col-sm-6 rounded form-floating ">
																			<select class="form-select" id="floatingInput" x-model="row.area" name="area" aria-label="Default select example">
																				<option>--- اختر المحافظة ---</option>
																				{% for key, value in lookups.city %}

																					<option value="{{ key }}" {{ old.city == key ? 'selected' : '' }}>{{ value }}</option>

																				{% endfor %}
																			</select>
																			<label for="floatingInput">المحافظة
																			</label>
																		</div>
																	</div>
																</div>
																{# {% endfor %} #}
															</div>
															<div class="modal-footer">
																<button type="button" class="btn btn-secondary " data-bs-dismiss="modal">إغلاق</button>
																<button type="button" x-on:click="editDevice($event.target, row, name, device_ip, area)" class="btn btn-info">حفظ</button>
															</div>
														</div>
													</div>
												</div>

												<!--<button type="button" x-bind:data-bs-target="'#details'+ row.id" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="تقرير الساعة ">
																																					<i class="bi bi-file-earmark-text fs-5"></i>
																																				</button>
																																				-->
												<div class="modal left fade" id="details" x-bind:id="'details'+ row.id" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
													<div class="modal-dialog">
														<div class="modal-content">
															<div class="modal-header">
																<h1 class="modal-title fs-5" id="staticBackdropLabel" x-text="row.name"></h1>
																{# <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> #}
															</div>
															<div class="modal-body"></div>

															<div class="modal-footer">
																<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
																<button type="button" class="btn btn-primary">Understood</button>
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</td>
								</tbody>
							</tr>
						</template>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div></div><script>
const dataTable = () => {
return {
table: null,
options: {
searching: false,
ordering: true,
paging: true,
lengthChange: true,
info: true,
autoWidth: true
},
searchTerm: '',
add_employee_no: '',
role: '',
id: '',
name: '',
device_ip: '',
area: '',
rows: [{% for value in data %}{
id: {{ value.id }},
ip: '{{ value.device_ip }}',
name: '{{ value.name }}',
status: '<i class="text-secondary bi bi-exclamation-circle"></i>',
area: '{{ lookups.city[value.area] }}',
serial: '{{ value.serial }}',
data: '---'
},{% endfor %}],
filteredRows() {
if (!this.searchTerm) {
return this.rows;
}

const term = this.searchTerm.toLowerCase();

return this.rows.filter(row => {
return row.ip.toLowerCase().includes(term) || row.name.toLowerCase().includes(term) || row.area.toLowerCase().includes(term);
});
},

allCheckConnect(button) {

this.rows.forEach(async (row) => {
checkوConnect(button, row, this.rows.length);

});
},
allSetTime(button) {
this.rows.forEach(async (row) => {
setTime(button, row, this.rows.length);
});
},


allTransferData(button) {
this.rows.forEach(async (row) => {
transferData(button, row, this.rows.length);

});
}


}
};</script></main>{% endblock %}{% block script %}<script src="/app/js/devices.js"></script>{% endblock %}
